<?php
$isMobile = ($this->layout == 'mobile') ||
            stristr($_SERVER['HTTP_USER_AGENT'], 'iphone') || 
            stristr($_SERVER['HTTP_USER_AGENT'], 'android') || 
            stristr($_SERVER['HTTP_USER_AGENT'],  'BlackBerry');
?>
<link rel="stylesheet" href="/styles/lightbox.css" type="text/css" media="screen" />
<script type="text/javascript"    src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript"   src="/scripts/lightbox.js"></script>
<script type="text/javascript"   src="/scripts/jwplayer/jwplayer.js"></script>
<script type="text/javascript"   src="/scripts/jquery.verticalscrollplus.js"></script>

<script type="text/javascript">
    var token = '<?php if (isset($this->token))
    echo $this->token; ?>';
    function loadAlertList() {
        $('#recording-list').load('/web/alert/alertlist?token='+token);
    }
    var chatIntervalDelay = 5000;
    var chatInterval;
    var currentChatContent = "";
    var noteListMaxHeight = 250;
    
    function loadChat() {
        var alertloggroupId = $('#hdAlertloggroupId').val();
        url = "/web/alert/loadnote?alertlogId=" + alertloggroupId;
        $.get(url, "", function (responseText, textStatus, XMLHttpRequest) {
            if (responseText != currentChatContent) { // only update when chat content has changed
                currentChatContent = responseText;
                $('#noteList').html(responseText);
                var chatScrollHeight = $('#noteList #chat-content').height();
                $('#noteList').height('auto'); // set auto height then get height
                var chatBoxHeight = $('#noteList').height();
                $('#noteList').height(chatBoxHeight); // set for plugin scroll
                if (chatBoxHeight < 1) {$('#noteList').hide();} else {$('#noteList').show();}
                // scroll down to bottom
            <?php if ($isMobile) : ?>
                setMobileChatBoxScroll();
                $('#noteList #chat-content').css('top', '-' + (chatScrollHeight - chatBoxHeight).toString() + 'px');
            <?php else: ?>        
                $('#noteList').scrollTop(chatScrollHeight); 
            <?php endif; ?>        
                
                // create animation 
                $('#noteList .note-count .node-count-content').css({'color': 'red', 'width': '1px'}).animate({"width": "100%"}, 500, function() {
                    $(this).css('color', '#800105');
                });
            }
        });
    }
    
    function setMobileChatBoxScroll() {
        $("#noteList").verticalScrollPlus({speed: 500, step: 180, upID: "#btnChatUp", downID: "#btnChatDown", scrollerID:'#chat-content'});
    }

    function setChatInterval(setup) {
        if (setup) {
            chatInterval = setInterval(loadChat, chatIntervalDelay);
        } else {
            window.clearInterval(chatInterval);
        }
    }
    
    function initDeleteChat() {
         $('#noteList .note-row .delete').live('click', function(){
            var url = "/web/alert/deletenote?alertlogId="+$('#hdAlertloggroupId').val()+"&noteId="+$(this).attr('id');
            setChatInterval(false);
            $.post(url, function(data){
                if(data == 'success') {
                    loadChat();
                    setChatInterval(true);
                } else {}
            });
	});
    }
    
    function doComment() {
        var msgEnterName = 'Enter your name';
        var msgEnterMessage = 'Enter message';
        $('#divAddNote').click(function() {
            $('#chat-form').slideToggle('slow', function() {
                document.location.href = '#enter-chat';
            });
        });
        $('#noteCancel').click(function() {
            $('#chat-form').slideUp('slow');
        });	
        $('#noteFrom').focus(function() { if($('#noteFrom').val() == msgEnterName) $('#noteFrom').val(''); });
        $('#noteFrom').blur(function(){ if($('#noteFrom').val() == '') { $('#noteFrom').val(msgEnterName); }});
        $('#noteMsg').focus(function(){ if($('#noteMsg').val() == msgEnterMessage) $('#noteMsg').val(''); });
        $('#noteMsg').blur(function() { if($('#noteMsg').val() == '') $('#noteMsg').val(msgEnterMessage); });
        // press enter
        $('#noteFrom').keydown(function(event) { if (event.keyCode == 13) { $('#noteMsg').focus(); }});
        $('#noteMsg').keydown(function(event) { if (event.keyCode == 13) { $('#noteAdd').click(); } });
        //send message to server
        $('#noteAdd').click(function() {
            if( ($('#noteFrom').val() == msgEnterName) || (jQuery.trim($('#noteFrom').val()) == '')) {
                alert('Please enter your name');
                $('#noteFrom').focus();
            }
            else if(($('#noteMsg').val() == msgEnterMessage) || (jQuery.trim($('#noteMsg').val()) == '')) {
                alert('Please enter message');	
                $('#noteMsg').focus();
            }
            else {
                var alertloggroupId = $('#hdAlertloggroupId').val();
                var url = '/web/alert/addnote?alertlogId=' + alertloggroupId + '&from=' + $('#noteFrom').val() + '&message=' + $('#noteMsg').val();
                // before send message
                setChatInterval(false); //stop chat repeat request
                // after send message
                $.post(url, function(data){
                    if(data == 'success') {
                        $('#noteMsg').val('');
                        loadChat();
                    } else {
                        alert('Your message has not sent.');
                    }
                    $('#noteMsg').focus();
                    setChatInterval(true); // continous chat
                });
            }
        });
    }

    function setListHeight() {
            var alertListHeight = $('.alert-list .col-left .scroll-alert').height();
            var noteListHeight = $('.col-left #noteList').height();
            alertListHeight = alertListHeight + noteListMaxHeight - noteListHeight;
            $('.alert-list .col-left .scroll-alert').css('max-height', alertListHeight.toString() + 'px');
    }

    function loadLocation() {
        var alertloggroupId = $('#hdAlertloggroupId').val();
        var url = '/web/alert/location?alertId='+ alertloggroupId;
        $('div.location').load(url);
    }
    
    //Google map
    function initialize(el, la,lo) {
        //var latlng2 = new google.maps.LatLng(21.040994081750677, 105.78739643096924);
        var latlng = new google.maps.LatLng(la, lo);
        var myOptions = {
            zoom: 12,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        };
        var map = new google.maps.Map(el, myOptions);
        var marker = new google.maps.Marker({
            position: latlng,
            title:"My location"
        });
        marker.setMap(map);
    }

    $(document).ready(function() {
        doComment();
        loadChat();
        setChatInterval(true);
        initDeleteChat();
        // Load alertlist by phoneNumber
        <?php if ($this->loginId): ?>loadAlertList();<?php endif; ?>
            
        $('.google_map_canvas').each(function() {
            var la = $(this).attr("la");
            var lo = $(this).attr("lo");
            if(la != null && lo != null) { initialize(this, la, lo); }
        });        
    });
        
    $(window).load(function() {
        setListHeight();
    });
</script>

<?php if (isset($this->alertDataRows)) : ?>
    <div class="alert-list id-<?php echo $this->loginId; ?>">
        <div class="alert-list-select-phone">
            <div class="title">&nbsp;</div>
        </div>

        <div class="clr"><?php if ($this->message) : ?><div class="message message-info"><?php echo $this->message ?></div><?php endif ?></div>
        <!-- COL-LEFT -->
        <div class="col-left">
            <h2 style="text-align: center" class="log-title">MESSAGE CENTER</h2>
            <?php
            if (!$isMobile) : // If mobile show alertLog with datalog
            ?>
                <div id="divAddNote" class="div-add-note"><input id="enter-chat" class="add-note" type="button" name="btnNoteAdd" value="ENTER RESPONDER CHAT"/></div>
               <div class="note-list" id="noteList"></div>
               <div id="chat-form" class="form-add-note" style="display: none;">
                    <input class="noteFrom" type="text" id="noteFrom" name="noteFrom" value="<?php if ($this->userName) {echo $this->userName;} else { echo 'Enter your name';} ?>" maxlength="50"/>
                    <input class="noteMsg"  type="text" id="noteMsg"  name="noteMsg"  value="Enter message" />
                    <br />
                    <input class="noteAdd" type="submit" id="noteAdd" name="noteAdd" value="Send"/>
                    <input class="noteCancel" type="button" id="noteCancel" name="noteCancel" value="Cancel"/>
                </div>
            <?php endif ?>
                
            <div class="scroll-alert">
            <?php
            if (!$isMobile) : // If mobile show alertLog with datalog
            ?>
            <?php if (isset($this->alertlogRows) && count($this->alertlogRows) > 0) : ?>
            <?php foreach ($this->alertlogRows as $row) : ?>
                <div class="details">
                    <div class="details-title">
                        Details
                    </div>
                    <div>
                        <table cellpadding="0" cellspacing="0">
                            <tr><td>From:</td><td><?php echo htmlspecialchars($this->phoneRows->getName()) ?></td></tr>
                            <tr><td>Number:</td><td><?php if (isset($this->phoneRows)) echo $this->phoneRows->getNumber() ?></td></tr>
                            <tr><td>Email:    </td><td><?php echo htmlspecialchars($this->phoneRows->getEmail()) ?></td></tr>
                            <tr><td>Time:    </td><td><?php echo $row->updated_date ?> GMT</td></tr>
                            <tr><td>Latitude:    </td><td><?php echo $row->latitude ?></td></tr>
                            <tr><td>Longitude:  </td><td><?php echo $row->longtitude ?></td></tr>
                            <tr><td>Text:     </td><td><?php echo htmlspecialchars($row->message) ?></td></tr>
                        </table>
                    </div>
                </div>
            <?php endforeach; ?>
        <?php endif; ?>
    <?php endif; ?>
        </div>
    </div>        
    <!-- END OF COL-LEFT -->
    <!-- COL-RIGHT -->
    <div class="col-right">
        <input type="hidden" id="hdAlertloggroupId" value="<?php if (isset($this->alertloggroupId)) echo $this->alertloggroupId ?>" />
        <?php if ($this->loginId) : ?>
            <div id="recording-list" class="recording-list"></div>
        <?php endif ?>
        <div class="clr"></div>
    <?php
    if ($isMobile) : // If mobile show alertLog with datalog
    ?>
        <div id="divAddNote" class="div-add-note"><input id="enter-chat" class="add-note" type="button" name="btnNoteAdd" value="ENTER RESPONDER CHAT"/></div>
        <div id="scroll-button">
            <a id="btnChatUp" title="Up">&nbsp;</a>
            <a id="btnChatDown" title="Down">&nbsp;</a>
        </div>
        <div class="note-list" id="noteList"></div>
        <div class="clr"></div>
        <div id="chat-form" class="form-add-note" style="display: none;">
            <input class="noteFrom" type="text" id="noteFrom" name="noteFrom" value="<?php if ($this->userName) {echo $this->userName;} else { echo 'Enter your name';} ?>" maxlength="50"/>
            <input class="noteMsg" multiple="multiple" type="text" id="noteMsg"  name="noteMsg"  value="Enter message" />
            <br />
            <input class="noteAdd" type="button" id="noteAdd" name="noteAdd" value="Send"/>
            <input class="noteCancel" type="button" id="noteCancel" name="noteCancel" value="Cancel"/>
        </div>
        <div class="clr"></div>
    <?php endif ?>
        <form method="post" action="">
            <h2 class="log-title">
                <span>DOWNLOAD CENTER</span>
    <?php if ($this->loginId && $this->isOwner && $this->isFileExist): ?>
                    <input onclick="return confirm('Are you sure you want to send these files to your email?')" type="submit" class="send_files_to_email" name="send_files_to_email" value="EMAIL DOWNLOADS"/>
    <?php endif ?>
            </h2>
        </form>
        <div class="alert">
            <div class="scroll-alert <?php if (!$this->loginId) : ?>alert-not-login<?php endif ?>">
                <?php
                if (isset($this->alertDataRows)) :
                    $count = 0;
                    $maps = $this->maps;
                ?>
                    <?php foreach ($this->alertDataRows as $key => $rows): ?>
                    <div class="alert-rows">
                        <?php
                        if ($isMobile) { // If mobile, show alertlog with same column
                            if (array_key_exists($count, $this->alertlogRows)) {
                                $alogRow = $this->alertlogRows[$count];
                                $count++; ////#### edit
                        ?>
                        <div class="details">
                            <div class="details-title">Details</div>
                            <div>
                                <table cellpadding="0" cellspacing="0">
                                    <tr><td>From:</td><td><?php echo htmlspecialchars($this->phoneRows->getName()) ?></td></tr>
                                    <tr><td>Number:</td><td><?php if (isset($this->phoneRows)) echo $this->phoneRows->getnumber() ?></td></tr>
                                    <tr><td>Email:    </td><td><?php echo htmlspecialchars($this->phoneRows->getEmail()) ?></td></tr>
                                    <tr><td>Time:    </td><td><?php echo $alogRow->updated_date ?> GMT</td></tr>
                                    <tr><td>Latitude:    </td><td><?php echo $alogRow->latitude ?></td></tr>
                                    <tr><td>Longitude:  </td><td><?php echo $alogRow->longtitude ?></td></tr>
                                    <tr><td>Text:     </td><td><?php echo $alogRow->message ?></td></tr>
                                </table>
                            </div>
                        </div>
                    <?php
                }
            }
            ?>
            <?php
            if (array_key_exists($key, $maps)) :
                $map = $maps[$key];
            ?>
                <div class="gmap">
                    <div class="google_map_canvas" la="<?php echo $map['latitude'] ?>" lo="<?php echo $map['longtitude'] ?>"></div>
                    <div class="date">Created Date: <?php echo $map['updated_date'] . " GMT"; ?></div>
                </div>
            <?php endif; ?>
            <div class="main-photo">
            <?php foreach ($rows as $row) : ?>
                <?php if ($row->type != null && $row->type == 0) :  //image  ?>
                    <div class="photo-block">
                        <div class="photo">
                            <a href="<?php echo $row->path ?>" rel="lightbox[flowers]" title="Photo by SOSbeacon">
                                <img src="<?php echo $row->path; ?>"/>
                            </a>
                        </div>
                        <div class="date">Created Date: <?php echo $row->created_date . " GMT"; ?></div>
                    </div>
                <?php endif; ?>
                <?php endforeach; ?>
            </div>
            <div class="main-audio">
            <?php $audioNum = 0; //Number of audio row?>
            <?php foreach ($rows as $row) : ?>
                <?php if ($row->type != 0) : //media  ?>
                    <?php $audioNum++//Up value Number of audio row to 1 ?>
                    <?php if ($isMobile) : ?>
                        <div class="mp3-play">
                            <a href="<?php echo $row->path; ?>"><img src="/images/mp3-play-icon.png" /></a>
                        </div>
                    <?php else : ?>
                        <div class="media">
                            <object id="player" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000" name="player" width="250" height="24">
                                <param name="movie" value="/scripts/jwplayer/player.swf" />
                                <param name="allowfullscreen" value="true" />
                                <param name="allowscriptaccess" value="always" />
                                <param name="flashvars" value="file=<?php echo $row->path; ?>" />
                                <embed type="application/x-shockwave-flash" id="player2" name="player2" src="/scripts/jwplayer/player.swf" width="250" height="25" allowscriptaccess="always" allowfullscreen="true" flashvars="file=<?php echo $row->path; ?>" />
                            </object>
                        </div>
                    <?php endif; ?>
                    <div class="datetime">Created Date: <?php echo $row->created_date . " GMT"; ?></div>
                <?php endif; ?>
            <?php endforeach; ?>
            <?php $isIphoneCheckin = 0; ?>
            <?php foreach ($rows as $row) : ?>
            <?php
            if ($audioNum == 0 && $row->alertlogType == 1) { //IF Emergency
                $isIphoneCheckin = 1;
            }
            ?>
            <?php endforeach; ?>
            <?php if ($isIphoneCheckin == 1) : ?>
                <div class="emergency-null">Emergency calls CAN NOT be recorded on iPhones due to Apple policy</div>
            <?php endif; ?>
                </div>
                <div class="clearFloat"></div>
            </div>
        <?php endforeach; ?>
    <?php endif; ?>
        </div>
    </div>
</div>
<div class="clr"></div>
</div>
    <!-- END OF COL-RIGHT -->
<?php else : ?>
    <div class="alert-list">
        <div class="div1">
            <br/><br/>
            Cannot found Review Phone History page with ID string: "<?php if (isset($this->token)) echo $this->token ?>"
        </div>
    </div>
<?php endif; ?>
